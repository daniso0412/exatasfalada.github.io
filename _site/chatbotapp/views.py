import tempfile
from django.shortcuts import redirect, render
from chatbot.settings import GENERATIVE_AI_KEY
from chatbotapp.models import ChatMessage
import google.generativeai as genai

def send_message(request):
    if request.method == 'POST':
        genai.configure(api_key=GENERATIVE_AI_KEY)
        model = genai.GenerativeModel("gemini-1.5-flash")

        #user_message = request.POST.get('user_message')
        uploaded_file = request.FILES.get('file')

        default_command = "Descreva o conteúdo desta imagem em português com 20 palavras. Você irá descrever imagens retiradas de um pdf de exercícios de cálculo 1. Reescreva toda a imagem, sendo que o texto que não conter NÚMEROS, EQUAÇÕES, FUNÇÕES, INEQUAÇÕES, ETC, apenas reescreva assim como está na imagem. Para equações de exatas, reescreva por extenso a equação, em que a linha é como seria a 'leitura' que será apresentado a seguir, não contendo NENHUMA, EXPLICAÇÃO,OBSERVAÇÃO OU ANALISE sobre Latex ou sobre a equação que será apresentado na imagem. Darei exemplos de equações em Latex e como elas devem ser lidas, use-as como referência para analisar as equações e transcrever apenas a equação da imagem de forma legível para um leitor de tela. Se a equação estiver entre um texto escrito corrido, aplique a descrição. Por favor, entre uma questão e outra, pule uma linha na sua resposta. Assim como itens((a),(b),(c),(d)). Textos e equações de uma mesma questão dever ficar juntas. Reescreva as equações da seguinte forma: \n 1) f(x) =\frac{{x^2 + 9x + 9}}{{x + 3}}. \n Lê-se:  'f' de 'x' é igual ao quociente de numerador 'x' ao quadrado mais nove  'x' mais nove e de denominador 'x' mais três; \n 2) x = 3.\nLê-se: 'x' é igual a três; \n 3) y = 2x^3 - 5x^2 + 4x - 7.\n Lê-se: 'y' é igual a dois 'x' ao cubo menos cinco 'x' ao quadrado mais quatro 'x' menos sete; \n 4) f(x) = \sin(3x) + \cos(2x). \n Lê-se: 'f' de 'x' é igual ao seno de três 'x' mais cosseno de dois 'x'; \n 5) \int_{{0}}^{{1}} (2x^2 + 3x) \, dx. \n Lê-se: integral definida de zero a um de: dois 'x' ao quadrado mais três 'x' em relação a x; \n 6) g(x) = \frac{{1}}{{x^2 + 1}}. \n Lê-se: 'g' de 'x' é igual ao quociente de numerador um e de denominador 'x' ao quadrado mais um; \n 7) \lim_{{x \to \infty}} \frac{{5x^2 + 8x}}{{3x^2 + 2}}. \n Lê-se: limite de 'x' tendendo ao infinito do quociente de numerador cinco 'x' ao quadrado mais oito 'x' e de denominado três 'x' ao quadrado mais dois; \n 8) \lim_{{x \to -\infty}} e^{1/x}. \n lê-se: limite de 'x' tendendo ao infinito de exponencial de quociente de numerador um e denominador x; \n 9) h(x) = \frac{{2x^2 + 9x + 9}}{{x + 3}}. \n Lê-se: 'h' de 'x' é igual ao quociente de numerador dois 'x' ao quadrado mais nove 'x' mais nove e de denominador 'x' mais três; \n 10) y = \frac{{3x}}{{x - 1}}. \n Lê-se: 'y' é igual ao quociente de numerador três 'x' e de denominador 'x' menos um; \n 11) y(x) = \frac{d}{dx} f(x). \n lê-se: 'y' de 'x' é igual a derivada de 'f' de 'x' em relação a 'x'; 12) [2h(x)]_a^b. \n Lê-se:  dois 'h' de x avaliado de 'a' a 'b'; \n 13) \frac{{1}}{{x^2 + 1}}. \n Lê-se:  quociente de numerador 1 e denominador 'x' ao quadrado mais 1; \n 14) \frac{[4 + (2 + h)^2] - [4 + 2^2]}{h}. \n lê-se:  quociente de numerador abre colchete quatro mais abre parênteses dois mais 'h' fecha parenteses ao quadrado fecha colchete menos abre colchete quatro mais dois ao quadrado fecha colchete e denominador 'h'; \n 15) \frac{s(t_0 + h) - s(t_0)}{h}. \n lê-se: quociente de numerador abre parênteses 's' de abre parênteses 't' subscrito zero mais 'h' fecha parênteses menos 's' de abre parênteses 't' subscrito zero fecha parênteses fecha parênteses e denominador 'h'; \n 16) s(t) = s_0 + v_0 t . \n lê-se: 's' de 't' é igual s subscrito zero mais 'v' subscrito zero vezes 't'; \n 17) \frac{s(2 + h) - s(2)}{h} = \frac{[4 + (2 + h)^2] - [4 + 2^2]}{h} = ...= \frac{h(4+h)}{h} = 4+h. \n lê-se: Quociente de numerador 's' abre parênteses dois mais 'h' fecha parênteses menos 's' de dois e denominador 'h' é igual ao quociente de numerador abre colchete quatro mais abre parênteses dois mais 'h' fecha parênteses ao quadrado fecha colchete menos abre colchete quatro mais dois ao quadrado fecha colchete e denominador 'h' é igual a 'reticências' que é igual ao quociente de numerador 'h' abre parênteses quatro mais 'h' fecha parênteses e denominador 'h' que é igual à quatro mais 'h'; \n 18) s_0, v, a \in \mathbb{R}. \n lê-se: 's' subscrito zero, 'v', 'a' pertencem aos reais; \n 19) z_{12}, x, y \in \mathbb{C}. \n lê-se: 'z' subscrito um dois, 'x', 'y' pertencem aos números complexos; \n 20) f : I \to \mathbb{R}. \n lê-se: 'f' dois pontos I seta Reais \n 21) g : R \ {7} \to \mathbb{R}. \n lê-se: 'g' dois pontos reais exceto número sete seta Reais \n 22) f : I -> R. \n lê-se:  'f' dois pontos I seta Reais \n 23) Mapeia elementos de \mathbb{R}. \n lê-se: Mapeia elementos dos conjuntos dos números Reais; \n 24) \mathbb{Z}. \n lê-se: Conjunto dos números inteiros \n 25)\mathbb{N}. \n lê-se: Conjunto dos números naturais \n 26) f'(a) = g'(x). \n lê-se: derivada da função 'f' de 'a' é igual a derivada da função 'g' de 'x'; \n 27) f'(z) = x + 2. \n lê-se: derivada da função 'f' de 'z' é igual a 'x' mais 2; \n 28) := \n lê-se: é definido como; \n 29) f(x) = |x+2+i| \n lê-se: Abre módulo 'x' mais dois mais 'i' fecha módulo; \n 30) g(x) = -|y| \n lê-se: menos abre módulo 'y' fecha módulo; \n 31) \frac{{x+\sqrt{x^2-1}}{{x - 1}} \n lê-se: quociente de numerador 'x' mais abre raiz quadrada 'x' ao quadrado menos 1 fecha raiz quadrada e denominador x menos 1; \n 32)\frac {{x+1}{\sqrt[3]{2x+3}} \n lê-se: quociente de numerador 'x'+1 e denominador abre raiz cúbica de dois 'x' mais três fecha raiz cúbica; \n 33) \lim_{{x \to 1}} \frac{{x^2 + 3x + 2}}{{x^2 - x + 2}} \n lê-se: limite de 'x' tendendo a um, do quociente de numerador 'x' ao quadrado mais três 'x' mais dois e de denominador 'x' ao quadrado menos 'x' mais dois; \n 34) I \subset \mathbb{R} \n lê-se: 'I' contido em Reais \n 35) a \in I \n lê-se: 'a' pertence a 'I' \n 36) f'(a) = \lim_{x \to a} \frac{f(x) - f(a)}{x - a} \n lê-se: Derivada de 'f' de 'a' é igual a limite de 'x' tendendo a 'a' do quociente de numerador 'f' de 'x' menos 'f' de 'a' e denominador 'x' menos 'a'. \n 37) \frac{x(5+h) + 2}{s(t_0)} = \frac{5 - x_5}{2} \n lê-se: Quociente de numerador 'x' abre parênteses cinco mais 'h' fecha parenteses mais 2 e denominador 's' abre parênteses 't' subscrito zero é igual ao quociente de numerador cinco menos 'x' subscrito cinco e denominador dois \n 38) y(x) = sqrt[3]{|x|} \n lê-se: 'y' de 'x' é igual a abre raíz cúbica abre módulo de 'x' fecha módulo fecha raíz cúbica \n 39) y''(x) = \frac{sqrt{x+5}+2x}{4} \n lê-se: Derivada dupla de 'y' de 'x' é igual ao quociente de numerador abre raíz quadrada 'x' mais cinco fecha raíz quadrada mais dois 'x' e denominador quadro \n 38) Se a função de um avião é dado por \frac{x(5+h) + 2}{s(t_0)} = \frac{5 - x_5}{2} , calcule a velocidade média \n lê-se: Se a função de um avião é dado por  Quociente de numerador 'x' abre parênteses cinco mais 'h' fecha parenteses mais 2 e denominador 's' abre parênteses 't' subscrito zero é igual ao quociente de numerador cinco menos 'x' subscrito cinco e denominador dois, calcule a velocidade média \n 40)\frac {{x+1}{\sqrt[3]{2x+3}} \n lê-se: quociente de numerador 'x'+1 e denominador abre raiz cúbica de dois 'x' mais três fecha raiz cúbica; \n 41) \frac{{x+\sqrt{x^2-1}}{{x - 1}} \n lê-se: quociente de numerador 'x' mais abre raiz quadrada 'x' ao quadrado menos 1 fecha raiz quadrada e denominador x menos 1; \n 42) \forall x \in dom(f + g) := dom(f) \cap dom(g) \n lê-se: Para todo 'x' pertence ao domínio de 'f' mais 'g' que é definido como domínio de 'f' intersecção domínio de 'g' \n 43) (f\cdot g)(x) := f(x)g(x) \n lê-se: abre parênteses 'f' vezes 'g' fecha parênteses de 'x' é definido como 'f' de 'x' vezes 'g' de 'x' \n 44) (\frac{g}{f})(x) := \frac{g(x)}{f(x)} \n lê-se: abre parênteses quociente de numerador 'g' e denominador 'f' fecha parênteses de 'x' é definido como quociente de numerador 'g' de 'x' e denominador 'f' de 'x' \n 45)  \sqrt{\frac{x+1}{y}} \n lê-se: abre raiz quadrada quociente de numerador 'x' mais um e denominador 'y' fecha raiz quadrada. \n 46) \lim_{x \to 2^{+}} y'(x) \n lê-se: limite de 'x' tendendo à dois pela direita da derivada de  'y' de 'x'. \n 47) (\cos(x) + 1) \n lê-se: abre parênteses cosseno abre parênteses x fecha parênteses mais um fecha parênteses; \n 48) (f \circ g)(x) = f(g(x)) \n lê-se: 'f' composta 'g' é igual a 'f' de 'g' de 'x'; \n 49) (f \circ f)(x) = f(f(x)) \n lê-se: 'f' composta 'f' é igual a 'f' de 'f' de 'x'; \n 50) \sqrt{x} \n lê-se: abre raíz quadrada de 'x' fecha raíz quadrada de 'x'; \n 51) \frac{sqrt[3]{5+x}}{sqrt{(1+x^2)^4}} \n lê-se: quociente de numerador abre raíz cúbica de cinco mais 'x' fecha raíz cúbica e denominador abre raíz quadrada abre parênteses um mais 'x' ao quadrado fecha parenteses elevado à quatro fecha raíz quadrada; \n 52) f(x) = \sqrt{1-sqrt{1-x^2}} \n lê-se: 'f' de 'x' é igual a abre raíz quadrada um menos abre raiz quadrada um menos 'x' ao quadrado fecha raíz quadrada fecha raíz quadrada; \n 53) g(x) = \frac{|x^2-1|}{\sqrt[3]{x+1}} \n lê-se: 'g' de 'x' é igual a quociente de abre módulo de 'x' ao quadrado menos um fecha modulo e denominador abre raíz cúbica de 'x' mais um fecha raíz cúbica; \n Dica 1: Acrescente o número que representa a questão ou o exercício do pdf e a palavra QUESTÃO: . Ou seja: 'Questão' um:, 'Questão dois', etc. \n Dica 2: Se em uma escrita de equação do pdf, houver uma letra (t,x,y,z,etc), e em seguida um número junto à letra (1,2,4,5,10,11) sem parênteses, colchetes ou chaves, a reescrita por extenso será 'letra subscrito número'. Ex: t0, lê-se 't' subscrito 0. x1, lê-se 'x' subscrito \n Dica 3: Sempre acrescente o título da lista, temas abordados, seções do livro, quando estes trechos estiverem dentro da lista apresentada. \n Dica 4: Se houver exercícios com itens da seguinte forma: (a) 'Exercício', (b) 'Exercício', (c) 'Exercício',(d) 'Exercício', reescreva aplicando Item 'a':, Item 'b':, Item 'c':. Ex: (a) f(x) =  2a, lê-se item 'a': 'f' de 'x' é igual 2 vezes a. \n Dica 5: Toda função que tiver " ' ", considere como a derivada da função. Ex: "f''(x)'", lê-se derivada da função 'f' de 'x'. g'(z), lê-se derivada da função 'g' de 'z'. \n Dica 6: Toda função que tiver '||', '()', \sqrt{x}, \sqrt[3]{x} sempre escreva por extenso quando que abre a notação, e quando que fecha a notação. Exemplo: |2+x|, lê-se abre módulo dois mais 'x' fecha módulo. (5+h), lê-se abre parênteses cinco mais 'h' fecha parênteses. \sqrt{2+x}, Lê-se abre raiz quadrada dois mais x fecha raiz quadrada. \sqrt[3]{x}, lê-se abre raiz cúbica de 'x' fecha raíz cúbica. \n Dica 7: Sempre que houver uma fração na equação a ser descrita, descreva qual é o numerador e o denominador. Ex: \frac{a + x}{b} lê -se: quociente com numerador 'a + x' e denominador 'b'. evite usar 'dividido' para denotar divisão."

        if uploaded_file and uploaded_file.name.endswith(('.png', '.jpg', '.jpeg', 'pdf')):
            mime_type = uploaded_file.content_type 
            # Cria um arquivo temporário para processar a imagem
            with tempfile.NamedTemporaryFile(delete=False) as temp_file:
                for chunk in uploaded_file.chunks():
                    temp_file.write(chunk)
                temp_file.flush()

                # Faz o upload da imagem para a API
                response = genai.upload_file(temp_file.name, mime_type=mime_type)
                bot_response = model.generate_content([default_command, response])
                bot_text = bot_response.text
        else:
            bot_response = model.generate_content(default_command)
            bot_text = bot_response.text
       

        # Salva a mensagem e o arquivo
        ChatMessage.objects.create(
            user_message=default_command, 
            bot_response=bot_text,
            file=uploaded_file  
        )
        
    return redirect('list_messages')



def list_messages(request):
    messages = ChatMessage.objects.all()
    return render(request, 'chatbot/list_messages.html', { 'messages': messages })